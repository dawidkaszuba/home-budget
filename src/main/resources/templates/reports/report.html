<!DOCTYPE html>
<html lang="pl"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Raporty</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- BOOTSTRAP -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">

</head>
<body>

<div th:insert="~{fragments/navbar}"></div>

<div class="container mt-4">

    <!-- ================= HEADER ================= -->
    <h1 class="h3 mb-4">üìä Raporty</h1>

    <!-- ================= FILTRY ================= -->
    <form method="get"
          th:action="@{/reports}"
          class="card card-body mb-4 shadow-sm">

        <div class="form-row">
            <div class="col-md-4 mb-2">
                <label>Od</label>
                <input type="date" class="form-control" name="from" th:value="${from}">
            </div>

            <div class="col-md-4 mb-2">
                <label>Do</label>
                <input type="date" class="form-control" name="to" th:value="${to}">
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary btn-block">üîç Filtruj</button>
            </div>
        </div>
    </form>

    <!-- ================= WYDATKI ================= -->
    <section>
        <h2 class="h5 mb-3 text-danger">Wydatki wg kategorii</h2>

        <div th:if="${!expensesByCategory.isEmpty()}"
             class="card shadow-sm mb-4 d-none d-md-block">
            <div class="card-body">
                <canvas id="expensesChart" height="120"></canvas>
            </div>
        </div>

        <!-- DESKTOP -->
        <div class="d-none d-md-block">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                <tr>
                    <th>Kategoria</th>
                    <th class="text-right">Kwota</th>
                    <th class="text-right">%</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="row : ${expensesByCategory}">
                    <td th:text="${row.categoryName}">Jedzenie</td>
                    <td class="text-right font-weight-bold"
                        th:text="${row.amount} + ' z≈Ç'"></td>
                    <td class="text-right text-muted expense-percent"
                        th:data-amount="${row.amount}">‚Äì</td>
                </tr>

                <tr th:if="${expensesByCategory.isEmpty()}">
                    <td colspan="3" class="text-center text-muted">
                        Brak danych
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- MOBILE -->
        <div class="d-md-none">
            <div class="card mb-2 shadow-sm"
                 th:each="row : ${expensesByCategory}">
                <div class="card-body">
                    <strong th:text="${row.categoryName}"></strong><br>
                    <span th:text="${row.amount}"></span> z≈Ç
                    <span class="text-muted expense-mobile-percent"
                          th:data-amount="${row.amount}"></span>
                </div>
            </div>
        </div>
    </section>

    <!-- ================= PRZYCHODY ================= -->
    <section class="mt-5">
        <h2 class="h5 mb-3 text-success">Przychody wg kategorii</h2>

        <div th:if="${!incomesByCategory.isEmpty()}"
             class="card shadow-sm mb-4 d-none d-md-block border-success">
            <div class="card-body">
                <canvas id="incomesChart" height="120"></canvas>
            </div>
        </div>

        <!-- DESKTOP -->
        <div class="d-none d-md-block">
            <table class="table table-striped table-bordered">
                <thead class="table-success">
                <tr>
                    <th>Kategoria</th>
                    <th class="text-right">Kwota</th>
                    <th class="text-right">%</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="row : ${incomesByCategory}">
                    <td th:text="${row.categoryName}">Pensja</td>
                    <td class="text-right font-weight-bold text-success"
                        th:text="${row.amount} + ' z≈Ç'"></td>
                    <td class="text-right text-muted income-percent"
                        th:data-amount="${row.amount}">‚Äì</td>
                </tr>

                <tr th:if="${incomesByCategory.isEmpty()}">
                    <td colspan="3" class="text-center text-muted">
                        Brak danych
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- MOBILE -->
        <div class="d-md-none">
            <div class="card mb-2 shadow-sm border-success"
                 th:each="row : ${incomesByCategory}">
                <div class="card-body">
                    <strong th:text="${row.categoryName}"></strong><br>
                    <span th:text="${row.amount}"></span> z≈Ç
                    <span class="text-muted income-mobile-percent"
                          th:data-amount="${row.amount}"></span>
                </div>
            </div>
        </div>
    </section>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ================= WSP√ìLNY JS ================= -->
<script th:inline="javascript">
    /*<![CDATA[*/

    function calculateTotal(values) {
        return values.reduce((a, b) => a + b, 0);
    }

    function fillPercentages(selector, total) {
        document.querySelectorAll(selector).forEach(el => {
            const value = Number(el.dataset.amount);
            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
            el.textContent = `(${percent}%)`;
        });
    }

    function fillPercentagesDesktop(selector, total) {
        document.querySelectorAll(selector).forEach(el => {
            const value = Number(el.dataset.amount);
            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
            el.textContent = percent + '%';
        });
    }

    function generateColors(count, saturation = 65, lightness = 55) {
    return Array.from({ length: count }, (_, i) =>
        `hsl(${Math.round((360 / count) * i)}, ${saturation}%, ${lightness}%)`
    );
}


    function renderPieChart(canvasId, labels, values, total) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || values.length === 0) return;

    const colors = generateColors(values.length);

    new Chart(canvas, {
        type: 'pie',
        data: {
            labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 14,
                        padding: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const v = ctx.raw;
                            const p = ((v / total) * 100).toFixed(1);
                            return `${ctx.label}: ${v} z≈Ç (${p}%)`;
                        }
                    }
                }
            }
        }
    });
}


    /* ===== WYDATKI ===== */
    const expenses = /*[[${expensesByCategory}]]*/ [];
    const expenseValues = expenses.map(e => Number(e.amount));
    const expenseLabels = expenses.map(e => e.categoryName);
    const expensesTotal = calculateTotal(expenseValues);

    renderPieChart(
        'expensesChart',
        expenseLabels,
        expenseValues,
        expensesTotal
    );

    fillPercentagesDesktop('.expense-percent', expensesTotal);
    fillPercentages('.expense-mobile-percent', expensesTotal);

    /* ===== PRZYCHODY ===== */
    const incomes = /*[[${incomesByCategory}]]*/ [];
    const incomeValues = incomes.map(i => Number(i.amount));
    const incomeLabels = incomes.map(i => i.categoryName);
    const incomesTotal = calculateTotal(incomeValues);

    renderPieChart(
        'incomesChart',
        incomeLabels,
        incomeValues,
        incomesTotal
    );

    fillPercentagesDesktop('.income-percent', incomesTotal);
    fillPercentages('.income-mobile-percent', incomesTotal);

    /*]]>*/
</script>

</body>
</html>
